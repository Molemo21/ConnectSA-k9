# GitHub Actions Production Deployment Workflow
#
# NOTE: Linter warnings about "Context access might be invalid" for secrets are FALSE POSITIVES.
# These warnings appear because the linter can't verify secrets exist in repository settings.
# All ${{ secrets.* }} references are valid GitHub Actions syntax and will work correctly.
#
# To suppress these warnings:
# 1. Configure secrets in GitHub: Settings â†’ Secrets and variables â†’ Actions
# 2. The workflow will run successfully once secrets are configured
# 3. These warnings can be safely ignored
#
name: Production Deployment

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'README.md'
      - 'docs/**'
      - '.github/**'
  workflow_dispatch: # Allow manual triggering

env:
  NODE_ENV: production
  CI: true
  NODE_VERSION: '18'

# Prevent concurrent deployments to production
concurrency:
  group: production-deployment
  cancel-in-progress: false # Don't cancel - wait for current deployment

jobs:
  # Pre-deployment Verification
  predeploy:
    runs-on: ubuntu-latest
    name: Pre-deployment Verification
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # Full history for better context
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
      
    - name: Generate Prisma Client
      run: npx prisma generate
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        DIRECT_URL: ${{ secrets.DIRECT_URL }}
      continue-on-error: false
      
    - name: Validate environment variables
      run: |
        echo "ðŸ” Validating required environment variables..."
        required_vars=(
          "DATABASE_URL"
          "DIRECT_URL"
          "NEXTAUTH_SECRET"
          "JWT_SECRET"
        )
        missing_vars=()
        for var in "${required_vars[@]}"; do
          if [ -z "${!var}" ]; then
            missing_vars+=("$var")
          fi
        done
        if [ ${#missing_vars[@]} -ne 0 ]; then
          echo "âŒ Missing required environment variables: ${missing_vars[*]}"
          exit 1
        fi
        echo "âœ… All required environment variables are set"
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        DIRECT_URL: ${{ secrets.DIRECT_URL }}
        NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        
    - name: Pre-deployment verification
      run: npm run predeploy
      env:
        NODE_ENV: production
        CI: true
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        DIRECT_URL: ${{ secrets.DIRECT_URL }}
        NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
      continue-on-error: false

  # Create Backup
  backup:
    runs-on: ubuntu-latest
    name: Create Production Backup
    needs: predeploy
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
      
    - name: Install PostgreSQL client
      run: |
        sudo apt-get update
        # Try to install PostgreSQL 17 client first, then fallback to 16 or default
        sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
        wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - 2>/dev/null || curl --silent https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -
        sudo apt-get update
        sudo apt-get install -y postgresql-client-17 || sudo apt-get install -y postgresql-client-16 || sudo apt-get install -y postgresql-client-15 || sudo apt-get install -y postgresql-client
        # Verify pg_dump version
        pg_dump --version || echo "âš ï¸ Warning: Could not verify pg_dump version"
        
    - name: Create backup directory
      run: mkdir -p database-backups
      
    - name: Create production backup
      id: backup
      run: npm run backup:production
      env:
        NODE_ENV: production
        CI: true
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        DIRECT_URL: ${{ secrets.DIRECT_URL }}
      continue-on-error: false
      
    - name: Verify backup was created
      run: |
        if [ ! -d "database-backups" ] || [ -z "$(ls -A database-backups)" ]; then
          echo "âŒ Backup directory is empty or doesn't exist"
          exit 1
        fi
        echo "âœ… Backup created successfully"
        ls -lh database-backups/
        
    - name: Upload backup artifact
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: production-backup-${{ github.run_id }}
        path: database-backups/
        retention-days: 30 # Keep backups longer for production
        compression-level: 9

  # Resolve Applied Migrations
  resolve-applied-migrations:
    runs-on: ubuntu-latest
    name: Resolve Applied Migrations
    needs: [predeploy, backup]
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
      
    - name: Resolve applied migrations
      id: resolve
      run: npm run resolve:applied:migrations
      env:
        NODE_ENV: production
        CI: true
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        DIRECT_URL: ${{ secrets.DIRECT_URL }}
      continue-on-error: false

  # Deploy Database Migrations
  deploy-database:
    runs-on: ubuntu-latest
    name: Deploy Database Migrations
    needs: [predeploy, backup, resolve-applied-migrations]
    timeout-minutes: 20
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
      
    - name: Download backup artifact
      uses: actions/download-artifact@v4
      with:
        name: production-backup-${{ github.run_id }}
        path: database-backups/
        
    - name: Verify backup exists
      run: |
        if [ ! -d "database-backups" ] || [ -z "$(ls -A database-backups)" ]; then
          echo "âŒ Backup artifact not found"
          exit 1
        fi
        echo "âœ… Backup artifact verified"
        ls -lh database-backups/
        
    - name: Deploy database migrations
      id: migrate
      run: npm run deploy:db
      env:
        NODE_ENV: production
        CI: true
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        DIRECT_URL: ${{ secrets.DIRECT_URL }}
        NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
      continue-on-error: false
      
    - name: Verify migration success
      run: |
        echo "âœ… Database migrations deployed successfully"
        echo "Migration completed at: $(date -u +%Y-%m-%dT%H:%M:%SZ)"

  # Fix Production Services (Independent Job - Always Runs)
  fix-production-services:
    runs-on: ubuntu-latest
    name: Fix Production Services
    needs: [deploy-database]
    timeout-minutes: 10
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
      
    - name: Install TypeScript
      run: npm install -g tsx typescript
      
    - name: Generate Prisma Client
      run: npx prisma generate
      env:
        DATABASE_URL: ${{ secrets.PROD_DATABASE_URL || secrets.DATABASE_URL }}
        DIRECT_URL: ${{ secrets.DIRECT_URL }}
      continue-on-error: false
    
    - name: Fix production services directly
      run: npm run fix:production:services:direct
      env:
        NODE_ENV: production
        CI: true
        PROD_DATABASE_URL: ${{ secrets.PROD_DATABASE_URL || secrets.DATABASE_URL }}
        DATABASE_URL: ${{ secrets.PROD_DATABASE_URL || secrets.DATABASE_URL }}
      continue-on-error: false

  # Promote Reference Data (if DEV_DATABASE_URL is set)
  promote-reference-data:
    runs-on: ubuntu-latest
    name: Promote Reference Data
    needs: [predeploy, backup, deploy-database]
    timeout-minutes: 15
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
      
    - name: Install TypeScript
      run: npm install -g tsx typescript
      
    - name: Check if reference data promotion is configured
      id: check-config
      run: |
        if [ -z "$DEV_DATABASE_URL" ] || [ -z "$PROD_DATABASE_URL" ]; then
          echo "configured=false" >> $GITHUB_OUTPUT
          echo "âš ï¸ Reference data promotion skipped: DEV_DATABASE_URL or PROD_DATABASE_URL not configured"
        else
          echo "configured=true" >> $GITHUB_OUTPUT
          echo "âœ… Reference data promotion configured"
        fi
      env:
        DEV_DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}
        PROD_DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
      
    - name: Dry-run reference data promotion
      if: steps.check-config.outputs.configured == 'true'
      run: npm run sync:reference:dry-run
      env:
        NODE_ENV: production
        CI: true
        DEV_DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}
        PROD_DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
      continue-on-error: false
      
    - name: Apply reference data promotion
      if: steps.check-config.outputs.configured == 'true'
      run: npm run sync:reference:apply
      env:
        NODE_ENV: production
        CI: true
        DEV_DATABASE_URL: ${{ secrets.DEV_DATABASE_URL }}
        PROD_DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
      continue-on-error: false

  # Post-deployment Verification
  verify-deployment:
    runs-on: ubuntu-latest
    name: Verify Deployment
    needs: [deploy-database, fix-production-services, promote-reference-data]
    timeout-minutes: 10
    if: always() # Run even if previous jobs failed
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci --legacy-peer-deps
      
    - name: Install TypeScript
      run: npm install -g tsx typescript
      
    - name: Generate Prisma Client
      run: npx prisma generate
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        DIRECT_URL: ${{ secrets.DIRECT_URL }}
      continue-on-error: false
      
    - name: Verify database connection
      run: |
        echo "ðŸ” Verifying database connection..."
        node -e "
        const { PrismaClient } = require('@prisma/client');
        const prisma = new PrismaClient({
          datasources: { db: { url: process.env.DATABASE_URL } }
        });
        prisma.\$queryRaw\`SELECT 1\`
          .then(() => {
            console.log('âœ… Database connection successful');
            process.exit(0);
          })
          .catch(err => {
            console.error('âŒ Database connection failed:', err.message);
            process.exit(1);
          })
          .finally(() => prisma.\$disconnect());
        "
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        DIRECT_URL: ${{ secrets.DIRECT_URL }}
      continue-on-error: false
      
    - name: Verify production database state
      run: npm run verify:production:state
      env:
        NODE_ENV: production
        CI: true
        DATABASE_URL: ${{ secrets.PROD_DATABASE_URL || secrets.DATABASE_URL }}
        DIRECT_URL: ${{ secrets.DIRECT_URL }}
      continue-on-error: false
      
    - name: Verify frontend/backend synchronization
      run: npm run verify:production:frontend
      env:
        NODE_ENV: production
        CI: true
        DATABASE_URL: ${{ secrets.PROD_DATABASE_URL || secrets.DATABASE_URL }}
        DIRECT_URL: ${{ secrets.DIRECT_URL }}
      continue-on-error: false
      
    - name: Verify service names match config
      run: npm run verify:service:names
      env:
        NODE_ENV: production
        CI: true
        PROD_DATABASE_URL: ${{ secrets.PROD_DATABASE_URL || secrets.DATABASE_URL }}
        DATABASE_URL: ${{ secrets.PROD_DATABASE_URL || secrets.DATABASE_URL }}
        DIRECT_URL: ${{ secrets.DIRECT_URL }}
      continue-on-error: false
      
    - name: Check deployment status
      run: |
        if [ "${{ needs.deploy-database.result }}" != "success" ]; then
          echo "âŒ Database deployment failed"
          exit 1
        fi
        if [ "${{ needs.fix-production-services.result }}" != "success" ]; then
          echo "âŒ Production services fix failed"
          exit 1
        fi
        if [ "${{ needs.promote-reference-data.result }}" != "success" ] && [ "${{ needs.promote-reference-data.result }}" != "skipped" ]; then
          echo "âš ï¸ Reference data promotion had issues (check logs)"
        fi
        echo "âœ… Deployment verification complete"
        echo "âœ… Backend database state verified"
        echo "âœ… Frontend/backend synchronization verified"
        echo "âœ… Production services fixed and verified"

  # Notification (on failure or success)
  notify:
    runs-on: ubuntu-latest
    name: Send Notification
    needs: [predeploy, backup, resolve-applied-migrations, deploy-database, fix-production-services, promote-reference-data, verify-deployment]
    if: always() # Always run, regardless of previous job status
    timeout-minutes: 5
    
    steps:
    - name: Determine deployment status
      id: status
      run: |
        if [ "${{ needs.verify-deployment.result }}" == "success" ]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "message=âœ… Production deployment completed successfully" >> $GITHUB_OUTPUT
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "message=âŒ Production deployment failed" >> $GITHUB_OUTPUT
        fi
        
    - name: Create deployment summary
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** ${{ steps.status.outputs.status }}" >> $GITHUB_STEP_SUMMARY
        echo "**Message:** ${{ steps.status.outputs.message }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Job Results:" >> $GITHUB_STEP_SUMMARY
        echo "- Pre-deployment: ${{ needs.predeploy.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Backup: ${{ needs.backup.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Resolve Applied Migrations: ${{ needs.resolve-applied-migrations.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Database Migration: ${{ needs.deploy-database.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Fix Production Services: ${{ needs.fix-production-services.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Reference Data: ${{ needs.promote-reference-data.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Verification: ${{ needs.verify-deployment.result }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
        
    # Uncomment and configure if you want email/Slack notifications
    # - name: Send email notification
    #   if: failure()
    #   uses: dawidd6/action-send-mail@v3
    #   with:
    #     server_address: smtp.gmail.com
    #     server_port: 465
    #     username: ${{ secrets.EMAIL_USERNAME }}
    #     password: ${{ secrets.EMAIL_PASSWORD }}
    #     subject: "Production Deployment Failed"
    #     body: "Deployment failed. Check GitHub Actions for details."
    #     to: your-team@example.com
    #     from: ci@example.com

#!/usr/bin/env node

/**
 * Postinstall Script - Install Prisma Guard
 * 
 * This script replaces the Prisma binary with our wrapper to enforce
 * npm script execution. This ensures even direct `npx prisma` usage
 * goes through our safety checks.
 * 
 * Runs automatically after `npm install` via postinstall hook.
 */

const fs = require('fs');
const path = require('path');

function installPrismaGuard() {
  const prismaBinPath = path.join(process.cwd(), 'node_modules', '.bin', 'prisma');
  const wrapperPath = path.join(process.cwd(), 'scripts', 'prisma-wrapper.js');
  const backupPath = path.join(process.cwd(), 'node_modules', '.bin', 'prisma.original');
  
  // Check if Prisma binary exists
  if (!fs.existsSync(prismaBinPath)) {
    console.log('‚ö†Ô∏è  Prisma binary not found, skipping guard installation');
    return;
  }
  
  // Check if wrapper exists
  if (!fs.existsSync(wrapperPath)) {
    console.log('‚ö†Ô∏è  Prisma wrapper not found, skipping guard installation');
    return;
  }
  
  try {
    // Backup original Prisma binary if not already backed up
    if (!fs.existsSync(backupPath)) {
      fs.copyFileSync(prismaBinPath, backupPath);
      console.log('‚úÖ Backed up original Prisma binary');
    }
    
    // Read wrapper script
    const wrapperContent = fs.readFileSync(wrapperPath, 'utf-8');
    
    // Create wrapper script that calls our guard
    const guardScript = `#!/usr/bin/env node
// Prisma Guard Wrapper - Auto-generated by install-prisma-guard.js
// This file replaces the Prisma binary to enforce npm script execution

const { spawn } = require('child_process');
const path = require('path');

// Check if running via npm script
function isRunningViaNpmScript() {
  return !!process.env.npm_lifecycle_event || 
         (process.env.npm_config_user_agent && process.env.npm_config_user_agent.includes('npm'));
}

// Get original Prisma binary
function getOriginalPrisma() {
  const originalPath = path.join(__dirname, 'prisma.original');
  const fs = require('fs');
  if (fs.existsSync(originalPath)) {
    return originalPath;
  }
  // Fallback to npx
  return 'prisma';
}

// Main execution
if (!isRunningViaNpmScript()) {
  const command = process.argv.slice(2).join(' ') || 'unknown command';
  
  console.error('\\n' + '='.repeat(80));
  console.error('üö® BLOCKED: Direct Prisma CLI usage is not allowed');
  console.error('='.repeat(80));
  console.error('');
  console.error('Prisma commands must be executed through npm scripts to ensure');
  console.error('environment validation and safety checks are applied.');
  console.error('');
  console.error(\`Attempted command: prisma \${command}\`);
  console.error('');
  console.error('‚ùå Why this is blocked:');
  console.error('   - Direct Prisma CLI usage bypasses environment validation');
  console.error('   - Safety checks in scripts/validate-env-before-prisma.js are skipped');
  console.error('   - This could allow accidental production database access');
  console.error('');
  console.error('‚úÖ How to fix:');
  console.error('   Use npm scripts instead:');
  console.error('');
  console.error('   Instead of: npx prisma db push');
  console.error('   Use:        npm run db:push');
  console.error('');
  console.error('   Instead of: npx prisma migrate dev');
  console.error('   Use:        npm run db:migrate');
  console.error('');
  console.error('   Instead of: npx prisma generate');
  console.error('   Use:        npm run db:generate');
  console.error('');
  console.error('   See package.json for all available Prisma commands.');
  console.error('');
  console.error('='.repeat(80) + '\\n');
  
  process.exit(1);
}

// If via npm script, use original Prisma binary
const originalPrisma = getOriginalPrisma();
const prismaArgs = process.argv.slice(2);

const prismaProcess = spawn(originalPrisma, prismaArgs, {
  stdio: 'inherit',
  shell: true,
  env: process.env,
});

prismaProcess.on('exit', (code) => {
  process.exit(code || 0);
});

prismaProcess.on('error', (error) => {
  console.error('Failed to execute Prisma:', error);
  process.exit(1);
});
`;
    
    // Write guard script
    fs.writeFileSync(prismaBinPath, guardScript);
    
    // Make executable (Unix-like systems)
    try {
      fs.chmodSync(prismaBinPath, '755');
    } catch (e) {
      // Windows doesn't support chmod, that's okay
    }
    
    console.log('‚úÖ Prisma guard installed successfully');
    console.log('   Direct Prisma CLI usage (npx prisma) is now blocked');
    console.log('   Use npm scripts (npm run db:*) instead');
  } catch (error) {
    console.error('‚ùå Failed to install Prisma guard:', error.message);
    // Don't fail the install process
  }
}

if (require.main === module) {
  installPrismaGuard();
}

module.exports = { installPrismaGuard };
